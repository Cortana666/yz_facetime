<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        .video {
            width: 480px;
            height: 320px;
        }

        @media (max-width: 640px) {
            .video {
                width: 320px;
                height: 240px;
            }
        }
    </style>
</head>
<body>
    <div id="count">
        房间学生人数：<span id="number"></span>
        <div id="group">
            
        </div>
    </div>
    <div id="func_div">
        <input type="button" value="网络检测" onclick="netCheck()">
        <input type="button" value="网络检测" onclick="netCheck()">
        <span id="downlink_status"></span>
        <span id="uplink_status"></span>
        <input type="button" value="设备检测" onclick="deviceCheck()">
        <span id="device_status"></span>
        <input type="button" value="加入" onclick="startCall()">
        <span id="microphone_status"></span>
        <input type="button" value="麦克风关闭" onclick="microphoneSet(false)">
        <input type="button" value="麦克风开启" onclick="microphoneSet(true)">
        <span id="camera_status"></span>
        <input type="button" value="摄像头关闭" onclick="cameraSet(false)">
        <input type="button" value="摄像头开启" onclick="cameraSet(true)">
        <input type="button" value="离开" onclick="leaveCall()">
    </div>
    <div id="video_div">
        <div id="video" class="video"></div>
    </div>
</body>
<script src="js/jquery-3.6.0.min.js"></script>
<!-- <script src="js/AgoraRTC_N-4.5.0.js"></script> -->
<script>
    // var rtc = {
    //     // 用来放置本地客户端。
    //     client: null,
    //     // 用来放置本地音视频频轨道对象。
    //     localAudioTrack: null,
    //     localVideoTrack: null,
    // };

    // var options = {
    //     // 替换成你自己项目的 App ID。
    //     appId: "d08b76fcc31a44d5b3974f6607bd9a65",
    //     // 传入目标频道名。
    //     channel: channel,
    //     // 如果你的项目开启了 App 证书进行 Token 鉴权，这里填写生成的 Token 值。
    //     token: agora_token,
    // };

    // // 开始网络质量检测
    // async function netCheck() {
    //     uplinkClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    //     downlinkClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
    //     try {
    //     const [localAudioTrack, localVideoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
    //     } catch (e) {
    //         console.log(e);
    //         alert(1);
    //     }
    //     const uplinkClientUid = await uplinkClient.join(options.appId, options.channel, options.token, null);
    //     const downlinkClientUid = await downlinkClient.join(options.appId, options.channel, options.token, null);

    //     await uplinkClient.publish([localAudioTrack, localVideoTrack]);
    //     downlinkClient.on("user-published", async (user, mediaType) => {
    //         await downlinkClient.subscribe(user, mediaType);
    //     })

    //     const networkQuality = [
    //         '质量未知',
    //         '质量极好',
    //         '用户主观感觉和极好差不多，但码率可能略低于极好',
    //         '用户主观感受有瑕疵但不影响沟通',
    //         '勉强能沟通但不顺畅',
    //         '网络质量非常差，基本不能沟通',
    //         '网络连接断开，完全无法沟通'
    //     ]

    //     // 获取上行网络质量
    //     uplinkClient.on("network-quality", (quality) => {
    //         console.log("uplink network quality", quality.uplinkNetworkQuality);
    //         $('#uplink_status').html("上行：" + networkQuality[quality.uplinkNetworkQuality]);
    //     });

    //     // 获取下行网络质量
    //     downlinkClient.on("network-quality", (quality) => {
    //         console.log("downlink network quality", quality.downlinkNetworkQuality);
    //         $('#downlink_status').html("下行：" + networkQuality[quality.uplinkNetworkQuality]);
    //     });

    //     // 获取上行统计数据
    //     uplinkVideoStats = uplinkClient.getLocalVideoStats();
    //     // 获取下行统计数据
    //     downlinkVideoStats = downlinkClient.getRemoteVideoStats()[uplinkClientUid];

    //     console.log("uplink video stats", uplinkVideoStats);
    //     console.log("downlink video stats", downlinkVideoStats);

    //     setTimeout(async function () {
    //         // 清空状态
    //         $('#uplink_status').html('');
    //         $('#downlink_status').html('');

    //         // 销毁本地音视频轨道。
    //         localAudioTrack.close();
    //         localVideoTrack.close();

    //         // 离开频道。
    //         await downlinkClient.leave();
    //         await uplinkClient.leave();
    //     }, 10 * 1000);
    // }

    // // 开始设备检测
    // async function deviceCheck() {
    //     // 获取所有音视频设备
    //     AgoraRTC.getDevices()
    //     .then(devices => {
    //         const audioDevices = devices.filter(function (device) {
    //             return device.kind === "audioinput";
    //         });
    //         const videoDevices = devices.filter(function (device) {
    //             return device.kind === "videoinput";
    //         });

    //         var selectedMicrophoneId = audioDevices[0].deviceId;
    //         var selectedCameraId = videoDevices[0].deviceId;
    //         return Promise.all([
    //             AgoraRTC.createCameraVideoTrack({ cameraId: selectedCameraId }),
    //             AgoraRTC.createMicrophoneAudioTrack({ microphoneId: selectedMicrophoneId }),
    //         ]);
    //     })
    //     .then(track => {
    //         track[0].play("video");
    //         var interval = setInterval(() => {
    //             const level = track[1].getVolumeLevel();
    //             console.log("local stream audio level", level);
    //             $('#device_status').html("音量：" + level * 100);
    //         }, 1000);

    //         setTimeout(async function () {
    //             // 清空状态
    //             $('#device_status').html("");

    //             // 销毁本地音视频轨道。
    //             clearInterval(interval)
    //             track[0].close();
    //             track[1].close();
    //         }, 5 * 1000);
    //     });
    // }

    // // 创建并加入频道
    // async function startCall() {
    //     // 创建本地客户端
    //     rtc.client = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

    //     // 订阅远端用户
    //     rtc.client.on("user-published", async (user, mediaType) => {
    //         // 开始订阅远端用户。
    //         await rtc.client.subscribe(user, mediaType);
    //         console.log("subscribe success");

    //         // 表示本次订阅的是视频。
    //         if (mediaType === "video") {
    //             // 订阅完成后，从 `user` 中获取远端视频轨道对象。
    //             const remoteVideoTrack = user.videoTrack;
    //             // 动态插入一个 DIV 节点作为播放远端视频轨道的容器。
    //             const playerContainer = document.createElement("div");
    //             // 给这个 DIV 节点指定一个 ID，这里指定的是远端用户的 UID。
    //             playerContainer.id = user.uid.toString();
    //             playerContainer.style.width = "640px";
    //             playerContainer.style.height = "480px";
    //             document.getElementById("video_div").append(playerContainer);

    //             // 订阅完成，播放远端音视频。
    //             // 传入 DIV 节点，让 SDK 在这个节点下创建相应的播放器播放远端视频。
    //             remoteVideoTrack.play(playerContainer);

    //             // 也可以只传入该 DIV 节点的 ID。
    //             // remoteVideoTrack.play(playerContainer.id);
    //         }

    //         // 表示本次订阅的是音频。
    //         if (mediaType === "audio") {
    //             // 订阅完成后，从 `user` 中获取远端音频轨道对象。
    //             const remoteAudioTrack = user.audioTrack;
    //             // 播放音频因为不会有画面，不需要提供 DOM 元素的信息。
    //             remoteAudioTrack.play();
    //         }
    //     });

    //     // 取消订阅远端用户
    //     rtc.client.on("user-unpublished", (user, mediaType) => {
    //         if (mediaType === "video") {
    //             // 获取刚刚动态创建的 DIV 节点。
    //             const playerContainer = document.getElementById(user.uid.toString());
    //             // 销毁这个节点。
    //             playerContainer.remove();
    //         }
    //     });

    //     // 加入目标频道
    //     const uid = await rtc.client.join(options.appId, options.channel, options.token, null);

    //     // 创建并发布本地音视频轨道
    //     const [localAudioTrack, localVideoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
    //     rtc.localAudioTrack = localAudioTrack;
    //     rtc.localVideoTrack = localVideoTrack;
    //     rtc.localVideoTrack.play("video");
    //     $("#microphone_status").html("麦克风开启");
    //     $("#camera_status").html("摄像头开启");

    //     await rtc.client.publish([rtc.localAudioTrack, rtc.localVideoTrack]);
    // }

    // // 暂时停用启用麦克风采集
    // async function microphoneSet(flag) {
    //     await rtc.localAudioTrack.setEnabled(flag);
    //     if (flag) {
    //         $("#microphone_status").html("麦克风开启");
    //     } else {
    //         $("#microphone_status").html("麦克风关闭");
    //     }
    // }

    // // 暂时停用启用摄像头采集
    // async function cameraSet(flag) {
    //     await rtc.localVideoTrack.setEnabled(flag);
    //     if (flag) {
    //         $("#camera_status").html("摄像头开启");
    //     } else {
    //         $("#camera_status").html("摄像头关闭");
    //     }
    // }

    // // 离开频道
    // async function leaveCall() {
    //     // 销毁本地音视频轨道。
    //     rtc.localAudioTrack.close();
    //     rtc.localVideoTrack.close();

    //     // 遍历远端用户。
    //     rtc.client.remoteUsers.forEach(user => {
    //         // 销毁动态创建的 DIV 节点。
    //         const playerContainer = document.getElementById(user.uid);
    //         playerContainer && playerContainer.remove();
    //     });

    //     // 清空状态
    //     $("#microphone_status").html("");
    //     $("#camera_status").html("");

    //     // 离开频道。
    //     await rtc.client.leave();
    // }
</script>
<script>
    var channel = getUrlQuery('channel');
    var agora_token = getUrlQuery('agora_token');
    var user_id = getUrlQuery('user_id');
    var name = getUrlQuery('name');
    var type = getUrlQuery('type');
    var student_list;
    
    ws = new WebSocket("ws://127.0.0.1:2000");

    ws.onopen = function () {
        ws.send(ots({ "send_type": "login", "user_id": user_id, "name": name, "channel": channel, "type": type, "student_token": "123456"}));
    };

    ws.onmessage = function (e) {
        data = sto(e.data);
        console.log(data);
        if (data.send_type == "login") {
            if (data.status != 1) {
                alert(data.message);
                location.href = "http://127.0.0.1/yz_facetime/app/"+name+".html"
            }
        }

        if (data.send_type == "list") {
            student_list = "";
            for (i = 0; i < data.data.length; i++) {
                student_list += "<p>"+data.data[i]+"</p>"
            }
            $('#group').html(student_list);
        }
    };

    // $('.send').click(function () {
    //     ws.send(name + '：' + $('.message').val());
    //     $('.message').val('');
    //     $('.message').focus();
    // });

    function ots(param) {
        return JSON.stringify(param)
    }

    function sto(param) {
        return JSON.parse(param)
    }

    function getUrlQuery(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (var i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) { return pair[1]; }
        }
        return (false);
    }
</script>
</html>
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>面试检测</title>
    <style>
        .video {
            width: 480px;
            height: 320px;
        }
    
        @media (max-width: 640px) {
            .video {
                width: 320px;
                height: 240px;
            }
        }
    </style>
</head>
<body>
    <div>
        <input class="func" type="button" value="网络检测" onclick="netCheck()">
        <span id="downlink_status"></span>
        <span id="uplink_status"></span>
    </div>
    <hr/>
    <div>
        <select id="microphone_device">
        
        </select>
        <select id="camera_device">
        
        </select>
        <input class="func" type="button" value="设备检测" onclick="deviceCheck()">
        <span id="device_status"></span>
    </div>
    <hr/>
    <div id="video_div">
        <div id="video" class="video"></div>
    </div>
    <hr/>
    <div>
        <input id="check" type="checkbox">我确认网络及设备没有问题，进入面试
        <input id="join" type="button" value="进入考场" disabled>
    </div>
</body>
<script src="js/jquery-3.6.0.min.js"></script>
<script src="js/AgoraRTC_N-4.5.0.js"></script>
<script>
    // 变量初始化
    var channel = getUrlQuery('channel');
    var agora_token = getUrlQuery('agora_token');
    var user_id = getUrlQuery('user_id');
    var name = getUrlQuery('name');
    var type = getUrlQuery('type');

    var rtc = {
        client: null,
        localAudioTrack: null,
        localVideoTrack: null,
    };
    var options = {
        appId: "d08b76fcc31a44d5b3974f6607bd9a65",
        channel: channel,
        token: agora_token,
    };
    var selectedMicrophoneId;
    var selectedCameraId;

    // 状态初始化
    getDevice();
    selectedMicrophoneId = $("#microphone_device").val();
    selectedCameraId = $("#camera_device").val();

    // 开始网络质量检测
    async function netCheck() {
        // 禁用所有功能
        $(".func").attr('disabled', true);

        setTimeout(async function () {
            // 启用所有功能
            $(".func").attr('disabled', false);
            
            // 清空状态
            $('#uplink_status').html('');
            $('#downlink_status').html('');

            // 销毁本地音视频轨道。
            localAudioTrack.close();
            localVideoTrack.close();

            // 离开频道。
            await downlinkClient.leave();
            await uplinkClient.leave();
        }, 10 * 1000);

        uplinkClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });
        downlinkClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

        const [localAudioTrack, localVideoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
        const uplinkClientUid = await uplinkClient.join(options.appId, options.channel, options.token, null);
        const downlinkClientUid = await downlinkClient.join(options.appId, options.channel, options.token, null);

        await uplinkClient.publish([localAudioTrack, localVideoTrack]);
        downlinkClient.on("user-published", async (user, mediaType) => {
            await downlinkClient.subscribe(user, mediaType);
        })

        const networkQuality = [
            '质量未知',
            '质量极好',
            '用户主观感觉和极好差不多，但码率可能略低于极好',
            '用户主观感受有瑕疵但不影响沟通',
            '勉强能沟通但不顺畅',
            '网络质量非常差，基本不能沟通',
            '网络连接断开，完全无法沟通'
        ]

        // 获取上行网络质量
        uplinkClient.on("network-quality", (quality) => {
            console.log("uplink network quality", quality.uplinkNetworkQuality);
            $('#uplink_status').html("上行：" + networkQuality[quality.uplinkNetworkQuality]);
        });

        // 获取下行网络质量
        downlinkClient.on("network-quality", (quality) => {
            console.log("downlink network quality", quality.downlinkNetworkQuality);
            $('#downlink_status').html("下行：" + networkQuality[quality.uplinkNetworkQuality]);
        });

        // 获取上行统计数据
        uplinkVideoStats = uplinkClient.getLocalVideoStats();
        // 获取下行统计数据
        downlinkVideoStats = downlinkClient.getRemoteVideoStats()[uplinkClientUid];

        console.log("uplink video stats", uplinkVideoStats);
        console.log("downlink video stats", downlinkVideoStats);
    }

    // 获取所有设备
    async function getDevice() {
        // 获取所有音视频设备
        AgoraRTC.getDevices()
        .then(devices => {
            const audioDevices = devices.filter(function (device) {
                return device.kind === "audioinput";
            });
            const videoDevices = devices.filter(function (device) {
                return device.kind === "videoinput";
            });

            for (let index = 0; index < audioDevices.length; index++) {
                $("#microphone_device").append('<option value="' + audioDevices[index]['deviceId'] + '">' + audioDevices[index]['label'] + '</option>')
            }

            for (let index = 0; index < videoDevices.length; index++) {
                $("#camera_device").append('<option value="' + videoDevices[index]['deviceId'] + '">' + videoDevices[index]['label'] + '</option>')
            }
        })
    }

    // 设备切换
    $("#microphone_device").change(function(){
        selectedMicrophoneId = $(this).val();
    });
    $("#camera_device").change(function(){
        selectedCameraId = $(this).val();
    });

    // 开始设备检测
    async function deviceCheck() {
        // 禁用所有功能
        $(".func").attr('disabled', true);

        AgoraRTC.getDevices()
        .then(devices => {
            return Promise.all([
                AgoraRTC.createCameraVideoTrack({ cameraId: selectedCameraId }),
                AgoraRTC.createMicrophoneAudioTrack({ microphoneId: selectedMicrophoneId }),
            ]);
        })
        .then(track => {
            track[0].play("video");
            var interval = setInterval(() => {
                const level = track[1].getVolumeLevel();
                console.log("local stream audio level", level);
                $('#device_status').html("音量：" + level * 100);
            }, 1000);

            setTimeout(async function () {
                // 启用所有功能
                $(".func").attr('disabled', false);

                // 清空状态
                $('#device_status').html("");

                // 销毁本地音视频轨道。
                clearInterval(interval)
                track[0].close();
                track[1].close();
            }, 5 * 1000);
        });
    }

    // 确认切换
    $("#check").change(function () {
        if ($(this).prop('checked')) {
            $("#join").attr('disabled', false);
        } else {
            $("#join").attr('disabled', true);
        }
    });

    // 进入考场
    $("#join").click(function() {
        if (type == 1) {
            location.href = "facetimeteacher.html?user_id=" + user_id + "&name=" + name + "&type=" + type + "&channel=" + channel + "&agora_token=" + agora_token + "&selectedMicrophoneId=" + selectedMicrophoneId + "&selectedCameraId=" + selectedCameraId;
        }
        if (type == 2) {
            location.href = "facetimestudent.html?user_id=" + user_id + "&name=" + name + "&type=" + type + "&channel=" + channel + "&agora_token=" + agora_token + "&selectedMicrophoneId=" + selectedMicrophoneId + "&selectedCameraId=" + selectedCameraId;
        }
    });

    // 获取url参数
    function getUrlQuery(variable) {
        var query = window.location.search.substring(1);
        var vars = query.split("&");
        for (let i = 0; i < vars.length; i++) {
            var pair = vars[i].split("=");
            if (pair[0] == variable) { return pair[1]; }
        }
        return (false);
    }
</script>
</html>